<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeoAlertAR - Sistema de Detecci√≥n de Incendios | Sierras Chicas Demo</title>
    
    <!-- Meta tags para SEO y social -->
    <meta name="description" content="Sistema de detecci√≥n temprana de incendios - Sierras Chicas, C√≥rdoba">
    <meta property="og:title" content="GeoAlertAR - Sierras Chicas">
    <meta property="og:description" content="Monitoreo satelital de riesgo de incendios en tiempo real">
    <meta property="og:url" content="https://geoalertar.com.ar">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üî•</text></svg>">
    
    <!-- Librer√≠as -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Estilos Personalizados -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }
        
        @keyframes pulse { 
            0% { transform: scale(1); } 
            50% { transform: scale(1.1); } 
            100% { transform: scale(1); } 
        }
        
        .pulse { 
            animation: pulse 2s infinite; 
            transform-origin: center center; 
        }
        
        .leaflet-div-icon { 
            background: transparent; 
            border: none; 
        }
        
        /* Desktop layout */
        .main-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            position: relative;
        }
        
        /* Sidebar desktop */
        .sidebar {
            width: 320px;
            background: white;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
            z-index: 900;
        }
        
        /* Map container */
        .map-container {
            flex: 1;
            height: 100%;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* Mobile button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1001;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border: none;
            cursor: pointer;
        }
        
        /* Mobile styles */
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }
            
            .sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                height: 100vh;
                width: 85%;
                max-width: 320px;
                z-index: 1000;
                transition: left 0.3s ease;
            }
            
            .sidebar.open {
                left: 0;
            }
            
            .map-container {
                width: 100vw;
            }
            
            .mobile-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }
            
            .mobile-overlay.show {
                display: block;
            }
            
            .leaflet-control-zoom {
                margin-top: 70px !important;
            }
        }
        
        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        /* Popup */
        .leaflet-popup-content-wrapper { 
            background: #ffffff; 
            color: #1f2937; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
        }
        
        /* Modal */
        #report-modal-bg { 
            z-index: 5000; 
            transition: opacity 0.3s ease; 
        }
        
        #report-modal-content { 
            transition: transform 0.3s ease; 
        }
        
        /* Watermark */
        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 3rem;
            color: rgba(59, 130, 246, 0.1);
            font-weight: bold;
            pointer-events: none;
            z-index: 1;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <!-- Mobile menu button -->
    <button class="mobile-menu-btn" id="mobile-menu-btn">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
    </button>
    
    <!-- Mobile overlay -->
    <div class="mobile-overlay" id="mobile-overlay"></div>
    
    <!-- Main container -->
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <!-- Close button for mobile -->
            <button class="absolute top-4 right-4 md:hidden" id="close-sidebar">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            
            <!-- Header -->
            <div class="p-4 border-b border-gray-200">
                <h1 class="text-2xl font-bold text-gray-900">üî• GeoAlert<span class="text-blue-600">AR</span></h1>
                <p class="text-sm text-gray-500">Demo Sierras Chicas v1.0</p>
                <p class="text-xs text-gray-400 mt-1">Sistema de detecci√≥n de incendios</p>
            </div>
            
            <!-- Info Banner -->
            <div class="bg-blue-50 border-l-4 border-blue-500 p-3 mx-4 mt-4 rounded-r">
                <p class="text-xs text-blue-800">
                    <strong>üî¨ Versi√≥n Demo:</strong> Sistema en evaluaci√≥n.
                    <a href="mailto:geoalertar1@gmail.com" class="underline">Enviar feedback</a>
                </p>
            </div>
            
            <!-- File loader section -->
            <div class="p-4 space-y-4 border-b border-gray-200">
                <div>
                    <button id="load-demo-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-all duration-200 flex items-center justify-center space-x-2 mb-2">
                        <span>üó∫Ô∏è Cargar Demo Sierras Chicas</span>
                    </button>
                    
                    <label for="csv-file-input" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-all duration-200 flex items-center justify-center space-x-2 cursor-pointer">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                        </svg>
                        <span>Cargar Otro CSV</span>
                    </label>
                    <input type="file" id="csv-file-input" class="hidden" accept=".csv">
                </div>
                <div id="status-message" class="text-center text-sm text-gray-500">
                    Click en "Cargar Demo" para comenzar
                </div>
            </div>
            
            <!-- Search panel -->
            <div id="search-panel" class="p-4 space-y-2 border-b border-gray-200 hidden">
                <label class="block text-sm font-medium text-gray-600">Buscar Localidad</label>
                <div class="flex space-x-2">
                    <select id="town-select" class="flex-1 bg-gray-50 border border-gray-300 rounded-md p-2 text-gray-900">
                        <option>Seleccione...</option>
                    </select>
                    <button id="search-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-3 rounded-md">
                        Ir
                    </button>
                </div>
            </div>
            
            <!-- Results panel -->
            <div id="results-panel" class="flex-1 p-4 space-y-4 overflow-y-auto custom-scrollbar hidden">
                <div id="stats-summary"></div>
                <div id="layer-filters"></div>
            </div>
            
            <!-- Footer -->
            <div class="p-3 border-t border-gray-200 text-xs text-gray-500">
                <p>üá¶üá∑ Sistema FireWatch Argentina</p>
                <p>¬© 2025 Federico Nicol√°s Sinato</p>
            </div>
        </aside>
        
        <!-- Map container -->
        <main class="map-container">
            <div id="map"></div>
        </main>
    </div>
    
    <!-- Report Modal -->
    <div id="report-modal-bg" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div id="report-modal-content" class="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transform scale-95 relative">
            <div class="watermark">GEOALERTAR</div>
            
            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-800">üìÑ Reporte de Inteligencia</h2>
                <button id="close-report-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
            </div>
            
            <div class="bg-red-50 border-l-4 border-red-500 p-3 mx-4 mt-4 rounded-r">
                <p class="text-xs text-red-800">
                    <strong>‚ö†Ô∏è CONFIDENCIAL:</strong> Propiedad de GeoAlertAR¬Æ. Prohibida su distribuci√≥n sin autorizaci√≥n.
                </p>
            </div>
            
            <div id="report-content" class="p-6 overflow-y-auto text-gray-700 space-y-4"></div>
            
            <div class="p-4 border-t border-gray-200 bg-gray-50 text-xs text-gray-600">
                <p class="text-center">
                    GeoAlertAR¬Æ | ID: <span id="report-id"></span> | ¬© 2025
                </p>
            </div>
        </div>
    </div>

    <script>
        // DEMO DATA EMBEDDED
        const DEMO_CSV_DATA = `ciudad,lat,lon,riesgo_final,nivel,poblacion,zona_tipo,region_detectada,ndvi,precipitacion_60d,temperatura,viento_kmh
agua_de_oro,-31.06694,-64.29056,75.5,ALTO,1500,localidad_principal,Sierras_Chicas,0.35,5.2,28.5,18
villa_cerro_azul,-31.06889,-64.32131,68.2,ALTO,800,localidad_principal,Sierras_Chicas,0.38,6.1,27.8,15
el_manzano,-31.07556,-64.29314,82.3,CR√çTICO,600,localidad_principal,Sierras_Chicas,0.28,4.8,29.2,22
punto_grid_001,-31.055,-64.285,45.6,MODERADO,100,grid_analisis,Sierras_Chicas,0.48,8.3,26.4,12
punto_grid_002,-31.080,-64.315,71.2,ALTO,100,grid_analisis,Sierras_Chicas,0.32,5.5,28.1,19
punto_grid_003,-31.045,-64.300,38.9,BAJO,100,grid_analisis,Sierras_Chicas,0.52,12.1,25.3,10
punto_grid_004,-31.090,-64.290,88.7,CR√çTICO,100,grid_analisis,Sierras_Chicas,0.22,3.2,30.1,25
punto_grid_005,-31.065,-64.310,54.3,MODERADO,100,grid_analisis,Sierras_Chicas,0.42,7.8,27.0,14`;

        // Global variables
        let map;
        let geoJsonLayer;
        let townData = [];
        let scanAreaCircles = [];
        
        // UI Elements
        const ui = {
            sidebar: document.getElementById('sidebar'),
            mobileMenuBtn: document.getElementById('mobile-menu-btn'),
            mobileOverlay: document.getElementById('mobile-overlay'),
            closeSidebar: document.getElementById('close-sidebar'),
            loadDemoBtn: document.getElementById('load-demo-btn'),
            fileInput: document.getElementById('csv-file-input'),
            statusMsg: document.getElementById('status-message'),
            searchPanel: document.getElementById('search-panel'),
            resultsPanel: document.getElementById('results-panel'),
            statsSummary: document.getElementById('stats-summary'),
            layerFilters: document.getElementById('layer-filters'),
            townSelect: document.getElementById('town-select'),
            searchBtn: document.getElementById('search-btn'),
            reportModalBg: document.getElementById('report-modal-bg'),
            reportContent: document.getElementById('report-content'),
            closeReportBtn: document.getElementById('close-report-btn')
        };

        // Initialize map
        function initMap() {
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri'
            });
            
            const hybridLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0','mt1','mt2','mt3'],
                attribution: 'Map data &copy; Google'
            });
            
            map = L.map('map', {
                center: [-31.07, -64.30],
                zoom: 11,
                layers: [hybridLayer]
            });
            
            L.control.layers({
                "H√≠brido": hybridLayer,
                "Sat√©lite": satelliteLayer
            }).addTo(map);
        }

        // Mobile menu handlers
        function setupMobileMenu() {
            ui.mobileMenuBtn?.addEventListener('click', () => {
                ui.sidebar.classList.add('open');
                ui.mobileOverlay.classList.add('show');
            });

            ui.closeSidebar?.addEventListener('click', closeMobileMenu);
            ui.mobileOverlay?.addEventListener('click', closeMobileMenu);
        }

        function closeMobileMenu() {
            ui.sidebar.classList.remove('open');
            ui.mobileOverlay.classList.remove('show');
        }

        // Load demo data
        function loadDemoData() {
            ui.statusMsg.textContent = 'Cargando demo Sierras Chicas...';
            processCSVData(DEMO_CSV_DATA);
            if (window.innerWidth < 768) closeMobileMenu();
        }

        // Process CSV data
        function processCSVData(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',');
            
            townData = lines.slice(1).map(line => {
                const values = line.split(',');
                const obj = {};
                headers.forEach((header, i) => {
                    obj[header] = values[i];
                });
                return obj;
            });
            
            const geojsonData = convertToGeoJSON(townData);
            renderMapData(geojsonData);
            updateSidebar(calculateSummary(townData));
            populateTownSelector(townData);
            
            ui.statusMsg.textContent = `‚úÖ ${townData.length} puntos cargados`;
            ui.searchPanel.classList.remove('hidden');
            ui.resultsPanel.classList.remove('hidden');
        }

        // Convert to GeoJSON
        function convertToGeoJSON(data) {
            const features = data.map(row => ({
                type: "Feature",
                geometry: {
                    type: "Point",
                    coordinates: [parseFloat(row.lon), parseFloat(row.lat)]
                },
                properties: {
                    nombre: row.ciudad.replace(/_/g, ' '),
                    riesgo_final: parseFloat(row.riesgo_final),
                    nivel: row.nivel,
                    poblacion: parseInt(row.poblacion) || 100,
                    region_detectada: row.region_detectada || 'Sierras Chicas',
                    zona_tipo: row.zona_tipo || 'N/A',
                    ndvi: row.ndvi || 'N/A',
                    precipitacion_60d: row.precipitacion_60d || 'N/A',
                    temperatura: row.temperatura || 'N/A',
                    viento_kmh: row.viento_kmh || 'N/A'
                }
            }));
            
            return { type: "FeatureCollection", features };
        }

        // Calculate summary
        function calculateSummary(data) {
            const summary = { total: data.length, critico: 0, alto: 0, moderado: 0, bajo: 0 };
            data.forEach(row => {
                switch(row.nivel) {
                    case 'CR√çTICO': summary.critico++; break;
                    case 'ALTO': summary.alto++; break;
                    case 'MODERADO': summary.moderado++; break;
                    case 'BAJO': summary.bajo++; break;
                }
            });
            return summary;
        }

        // Render map data
        function renderMapData(geojsonData) {
            if (geoJsonLayer) map.removeLayer(geoJsonLayer);
            scanAreaCircles.forEach(c => map.removeLayer(c));
            scanAreaCircles = [];

            geoJsonLayer = L.geoJSON(geojsonData, {
                pointToLayer: (feature, latlng) => {
                    const circle = L.circle(latlng, {
                        radius: 1000,
                        color: '#ffffff',
                        weight: 1,
                        opacity: 0.3,
                        fillColor: '#ffffff',
                        fillOpacity: 0.05
                    });
                    scanAreaCircles.push(circle);

                    const colors = {
                        'CR√çTICO': '#ef4444',
                        'ALTO': '#f97316',
                        'MODERADO': '#eab308',
                        'BAJO': '#22c55e'
                    };
                    
                    const color = colors[feature.properties.nivel] || '#6b7280';
                    
                    return L.marker(latlng, {
                        icon: L.divIcon({
                            html: `<div style="width: 32px; height: 42px;">
                                <svg viewBox="0 0 32 42" fill="none" style="filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));">
                                    <path d="M16 0C7.16344 0 0 7.16344 0 16C0 28 16 42 16 42C16 42 32 28 32 16C32 7.16344 24.8366 0 16 0Z" fill="${color}"/>
                                    <circle cx="16" cy="16" r="7" fill="white"/>
                                </svg>
                            </div>`,
                            className: 'leaflet-div-icon',
                            iconSize: [32, 42],
                            iconAnchor: [16, 42]
                        })
                    });
                },
                onEachFeature: (feature, layer) => {
                    const props = feature.properties;
                    layer.bindPopup(`
                        <div style="min-width: 200px;">
                            <h3 class="font-bold text-lg">${props.nombre.toUpperCase()}</h3>
                            <p><strong>${props.nivel}</strong> (${props.riesgo_final.toFixed(1)}%)</p>
                            <hr class="my-2">
                            <p>NDVI: ${props.ndvi}</p>
                            <p>Precipitaci√≥n: ${props.precipitacion_60d} mm</p>
                            <p>Temperatura: ${props.temperatura}¬∞C</p>
                            <p>Viento: ${props.viento_kmh} km/h</p>
                            <button onclick='generateReport(${JSON.stringify(props)})' 
                                class="w-full mt-2 bg-blue-500 text-white p-2 rounded">
                                Generar Reporte
                            </button>
                        </div>
                    `);
                }
            }).addTo(map);
            
            if (geojsonData.features.length > 0) {
                map.fitBounds(geoJsonLayer.getBounds().pad(0.1));
            }
        }

        // Update sidebar
        function updateSidebar(summary) {
            ui.statsSummary.innerHTML = `
                <h3 class="text-lg font-semibold mb-2">Resumen de Riesgo</h3>
                <div class="bg-gray-50 p-3 rounded-lg space-y-2 text-sm">
                    <div>Total: ${summary.total}</div>
                    <div class="text-red-600">üî¥ Cr√≠tico: ${summary.critico}</div>
                    <div class="text-orange-500">üü† Alto: ${summary.alto}</div>
                    <div class="text-yellow-500">üü° Moderado: ${summary.moderado}</div>
                    <div class="text-green-600">üü¢ Bajo: ${summary.bajo}</div>
                </div>
            `;
        }

        // Populate town selector
        function populateTownSelector(data) {
            const towns = [...new Set(data.map(d => d.ciudad.replace(/_/g, ' ')))];
            ui.townSelect.innerHTML = '<option value="">Seleccione...</option>';
            towns.forEach(town => {
                const option = document.createElement('option');
                option.value = town;
                option.textContent = town;
                ui.townSelect.appendChild(option);
            });
        }

        // Generate report
        function generateReport(props) {
            const reportId = 'GAR-' + Date.now().toString(36).toUpperCase();
            document.getElementById('report-id').textContent = reportId;
            
            ui.reportContent.innerHTML = `
                <h3 class="text-lg font-bold mb-2">
                    Reporte: ${props.nombre.toUpperCase()}
                </h3>
                <p>Nivel: <strong>${props.nivel}</strong> (${props.riesgo_final}%)</p>
                <p>Regi√≥n: ${props.region_detectada}</p>
                <div class="mt-4 p-3 bg-yellow-50 rounded">
                    <p class="text-sm">Sistema GeoAlertAR¬Æ - Uso exclusivo autorizado</p>
                </div>
            `;
            
            ui.reportModalBg.classList.remove('hidden');
            setTimeout(() => ui.reportModalBg.classList.remove('opacity-0'), 10);
        }

        // Setup event listeners
        function setupEventListeners() {
            ui.loadDemoBtn?.addEventListener('click', loadDemoData);
            ui.fileInput?.addEventListener('change', handleFileUpload);
            ui.searchBtn?.addEventListener('click', handleSearch);
            ui.closeReportBtn?.addEventListener('click', () => {
                ui.reportModalBg.classList.add('opacity-0');
                setTimeout(() => ui.reportModalBg.classList.add('hidden'), 300);
            });
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => processCSVData(e.target.result);
                reader.readAsText(file);
            }
        }

        function handleSearch() {
            const selected = ui.townSelect.value;
            if (selected) {
                const point = townData.find(d => d.ciudad.replace(/_/g, ' ') === selected);
                if (point) {
                    map.flyTo([parseFloat(point.lat), parseFloat(point.lon)], 14);
                    if (window.innerWidth < 768) closeMobileMenu();
                }
            }
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            setupMobileMenu();
            setupEventListeners();
        });
    </script>
</body>
</html>
